<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å·æ–‡ç« æŠ“å–</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 960px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .btn-action {
            margin-right: 5px;
        }
        .loading {
            display: none;
            margin-left: 10px;
        }
        .alert {
            display: none;
            margin-top: 15px;
        }
        .schedules-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .logs-list {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex flex-column align-items-center mb-4">
            <h1 class="display-5 fw-bold">WZå†…å®¹ç®¡ç†ç³»ç»Ÿ</h1>
            <p class="fs-5 text-muted">å¤šæºå†…å®¹é‡‡é›†ä¸ç®¡ç†å¹³å°</p>
        </header>

        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <h1>å†…å®¹ç®¡ç†æ§åˆ¶å°</h1>
                <div>
                    <a href="{{ url_for('view_articles') }}" class="btn btn-success me-2">
                        <i class="bi bi-list-ul"></i> æŸ¥çœ‹æœ€æ–°æ–‡ç« 
                    </a>
                    <a href="{{ url_for('view_logs') }}" class="btn btn-info">
                        <i class="bi bi-clock-history"></i> æŸ¥çœ‹ä»»åŠ¡æ—¥å¿—
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <!-- ç«‹å³æŠ“å–é“¾æ¥ -->
                <div class="card">
                    <div class="card-header">ğŸ“± è·å–å¾®ä¿¡é“¾æ¥</div>
                    <div class="card-body">
                        <p class="text-muted small">è·å–å¾®ä¿¡å…¬ä¼—å·æ–‡ç« é“¾æ¥å¹¶å­˜å‚¨åˆ°æ•°æ®åº“</p>
                        <form id="crawlForm">
                            <div class="mb-3">
                                <label for="crawlAccount" class="form-label">å…¬ä¼—å·åç§° (å¯é€‰)</label>
                                <input type="text" class="form-control" id="crawlAccount" name="account" placeholder="ç•™ç©ºè¡¨ç¤ºæŠ“å–æ‰€æœ‰é…ç½®çš„å…¬ä¼—å·">
                            </div>
                            <div class="mb-3">
                                <label for="crawlLimit" class="form-label">æ¯ä¸ªå…¬ä¼—å·æŠ“å–æ–‡ç« æ•°é‡</label>
                                <input type="number" class="form-control" id="crawlLimit" name="limit" value="10" min="1" max="100">
                            </div>
                            <button type="submit" class="btn btn-primary" id="crawlBtn">
                                è·å–é“¾æ¥
                                <span class="spinner-border spinner-border-sm loading" id="crawlLoading"></span>
                            </button>
                        </form>
                        <div class="alert" id="crawlAlert"></div>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨URLå…¥åº“ -->
                <div class="card">
                    <div class="card-header">ğŸ”— æ‰‹åŠ¨URLå…¥åº“</div>
                    <div class="card-body">
                        <p class="text-muted small">è¾“å…¥URLä¿å­˜åˆ°æ•°æ®åº“ï¼Œç­‰å¾…åç»­é‡‡é›†</p>
                        <form id="urlCrawlForm">
                            <div class="mb-3">
                                <label for="urlInput" class="form-label">æ–‡ç« URL</label>
                                <textarea class="form-control" id="urlInput" name="urls" rows="3"
                                    placeholder="è¾“å…¥è¦é‡‡é›†çš„URLï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;https://linux.do/t/topic/123456&#10;https://www.nodeseek.com/post-123456-1"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="urlSourceType" class="form-label">æ¥æºç±»å‹</label>
                                <select class="form-control" id="urlSourceType" name="source_type">
                                    <option value="external">å¤–éƒ¨é“¾æ¥</option>
                                    <option value="linux_do">Linux.do</option>
                                    <option value="nodeseek">NodeSeek</option>
                                    <option value="wechat">å¾®ä¿¡å…¬ä¼—å·</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="urlSourceName" class="form-label">æ¥æºåç§°</label>
                                <input type="text" class="form-control" id="urlSourceName" name="source_name" value="æ‰‹åŠ¨å¯¼å…¥" placeholder="ä¸ºè¿™æ‰¹é“¾æ¥è®¾ç½®ä¸€ä¸ªæ¥æºåç§°">
                            </div>
                            <button type="submit" class="btn btn-primary" id="urlCrawlBtn">
                                ä¿å­˜åˆ°æ•°æ®åº“
                                <span class="spinner-border spinner-border-sm loading" id="urlCrawlLoading"></span>
                            </button>
                        </form>
                        <div class="alert" id="urlCrawlAlert"></div>
                    </div>
                </div>

                <!-- å†…å®¹é‡‡é›† -->
                <div class="card">
                    <div class="card-header">ğŸ” å†…å®¹é‡‡é›†</div>
                    <div class="card-body">
                        <p class="text-muted small">é‡‡é›†å·²å­˜å‚¨é“¾æ¥çš„æ–‡ç« å†…å®¹</p>
                        <form id="contentCrawlForm">
                            <div class="mb-3">
                                <label for="contentSourceType" class="form-label">å†…å®¹æ¥æº</label>
                                <select class="form-control" id="contentSourceType" name="source_type">
                                    <option value="">å…¨éƒ¨æ¥æº</option>
                                    <option value="wechat">å¾®ä¿¡å…¬ä¼—å·</option>
                                    <option value="linux_do">Linux.do</option>
                                    <option value="nodeseek">NodeSeek</option>
                                    <option value="external">å¤–éƒ¨é“¾æ¥</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="contentLimit" class="form-label">é‡‡é›†æ•°é‡é™åˆ¶</label>
                                <input type="number" class="form-control" id="contentLimit" name="limit" value="50" min="1" max="200">
                            </div>
                            <div class="mb-3">
                                <label for="contentBatchSize" class="form-label">æ‰¹æ¬¡å¤§å°</label>
                                <input type="number" class="form-control" id="contentBatchSize" name="batch_size" value="5" min="1" max="10">
                            </div>
                            <button type="submit" class="btn btn-success" id="contentCrawlBtn">
                                å¼€å§‹é‡‡é›†
                                <span class="spinner-border spinner-border-sm loading" id="contentCrawlLoading"></span>
                            </button>
                        </form>
                        <div class="alert" id="contentCrawlAlert"></div>
                    </div>
                </div>

                <!-- æ›´æ–°å‡­è¯ -->
                <div class="card">
                    <div class="card-header">æ›´æ–°å‡­è¯</div>
                    <div class="card-body">
                        <p>æ›´æ–°å¾®ä¿¡å…¬ä¼—å¹³å°ç™»å½•å‡­è¯ï¼Œå°†æ‰“å¼€æµè§ˆå™¨å¹¶éœ€è¦æ‰«ç ç™»å½•ã€‚</p>
                        <button class="btn btn-warning" id="updateCredBtn">
                            æ›´æ–°å‡­è¯
                            <span class="spinner-border spinner-border-sm loading" id="updateCredLoading"></span>
                        </button>
                        <div class="alert" id="updateCredAlert"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- å®šæœŸé“¾æ¥æŠ“å– -->
                <div class="card">
                    <div class="card-header">â° å®šæœŸé“¾æ¥æŠ“å–</div>
                    <div class="card-body">
                        <form id="scheduleForm">
                            <div class="mb-3">
                                <label class="form-label">æŠ“å–é¢‘ç‡</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule_type" id="scheduleDaily" value="daily" checked>
                                    <label class="form-check-label" for="scheduleDaily">æ¯å¤©</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule_type" id="scheduleWeekly" value="weekly">
                                    <label class="form-check-label" for="scheduleWeekly">æ¯å‘¨</label>
                                </div>
                            </div>

                            <div class="mb-3" id="daysSelector" style="display: none;">
                                <label class="form-label">æ¯å‘¨å‡ æ‰§è¡Œ</label>
                                <div class="d-flex flex-wrap">
                                    {% for day_num, day_name in [
                                        (0, 'å‘¨ä¸€'), (1, 'å‘¨äºŒ'), (2, 'å‘¨ä¸‰'),
                                        (3, 'å‘¨å››'), (4, 'å‘¨äº”'), (5, 'å‘¨å…­'), (6, 'å‘¨æ—¥')
                                    ] %}
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" name="days" value="{{ day_num }}" id="day{{ day_num }}">
                                        <label class="form-check-label" for="day{{ day_num }}">{{ day_name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="scheduleTime" class="form-label">æ‰§è¡Œæ—¶é—´</label>
                                <input type="time" class="form-control" id="scheduleTime" name="time" value="09:00" required>
                            </div>

                            <div class="mb-3">
                                <label for="scheduleAccount" class="form-label">å…¬ä¼—å·åç§° (å¯é€‰)</label>
                                <input type="text" class="form-control" id="scheduleAccount" name="account" placeholder="ç•™ç©ºè¡¨ç¤ºæŠ“å–æ‰€æœ‰é…ç½®çš„å…¬ä¼—å·">
                            </div>

                            <div class="mb-3">
                                <label for="scheduleLimit" class="form-label">æ¯ä¸ªå…¬ä¼—å·æŠ“å–æ–‡ç« æ•°é‡</label>
                                <input type="number" class="form-control" id="scheduleLimit" name="limit" value="10" min="1" max="100">
                            </div>

                            <button type="submit" class="btn btn-primary" id="scheduleBtn">
                                è®¾ç½®å®šæœŸæŠ“å–
                                <span class="spinner-border spinner-border-sm loading" id="scheduleLoading"></span>
                            </button>
                        </form>
                        <div class="alert" id="scheduleAlert"></div>
                    </div>
                </div>

                <!-- å®šæœŸå†…å®¹é‡‡é›† -->
                <div class="card">
                    <div class="card-header">â° å®šæœŸå†…å®¹é‡‡é›†</div>
                    <div class="card-body">
                        <form id="scheduleContentForm">
                            <div class="mb-3">
                                <label class="form-label">é‡‡é›†é¢‘ç‡</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule_type" id="scheduleContentDaily" value="daily" checked>
                                    <label class="form-check-label" for="scheduleContentDaily">æ¯å¤©</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="schedule_type" id="scheduleContentWeekly" value="weekly">
                                    <label class="form-check-label" for="scheduleContentWeekly">æ¯å‘¨</label>
                                </div>
                            </div>

                            <div class="mb-3" id="contentDaysSelector" style="display: none;">
                                <label class="form-label">æ¯å‘¨å‡ æ‰§è¡Œ</label>
                                <div class="d-flex flex-wrap">
                                    {% for day_num, day_name in [
                                        (0, 'å‘¨ä¸€'), (1, 'å‘¨äºŒ'), (2, 'å‘¨ä¸‰'),
                                        (3, 'å‘¨å››'), (4, 'å‘¨äº”'), (5, 'å‘¨å…­'), (6, 'å‘¨æ—¥')
                                    ] %}
                                    <div class="form-check me-3">
                                        <input class="form-check-input" type="checkbox" name="days" value="{{ day_num }}" id="contentDay{{ day_num }}">
                                        <label class="form-check-label" for="contentDay{{ day_num }}">{{ day_name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="scheduleContentTime" class="form-label">æ‰§è¡Œæ—¶é—´</label>
                                <input type="time" class="form-control" id="scheduleContentTime" name="time" value="10:00" required>
                            </div>

                            <div class="mb-3">
                                <label for="scheduleContentSourceType" class="form-label">å†…å®¹æ¥æº</label>
                                <select class="form-control" id="scheduleContentSourceType" name="source_type">
                                    <option value="">å…¨éƒ¨æ¥æº</option>
                                    <option value="wechat">å¾®ä¿¡å…¬ä¼—å·</option>
                                    <option value="linux_do">Linux.do</option>
                                    <option value="nodeseek">NodeSeek</option>
                                    <option value="external">å¤–éƒ¨é“¾æ¥</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="scheduleContentLimit" class="form-label">é‡‡é›†æ•°é‡é™åˆ¶</label>
                                <input type="number" class="form-control" id="scheduleContentLimit" name="limit" value="50" min="1" max="200">
                            </div>

                            <button type="submit" class="btn btn-success" id="scheduleContentBtn">
                                è®¾ç½®å®šæœŸé‡‡é›†
                                <span class="spinner-border spinner-border-sm loading" id="scheduleContentLoading"></span>
                            </button>
                        </form>
                        <div class="alert" id="scheduleContentAlert"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å·²è®¾ç½®çš„å®šæœŸä»»åŠ¡ -->
        <div class="card mt-4">
            <div class="card-header">å·²è®¾ç½®çš„å®šæœŸä»»åŠ¡</div>
            <div class="card-body">
                <div class="schedules-list">
                    {% if schedules %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ä»»åŠ¡ç±»å‹</th>
                                <th>é¢‘ç‡</th>
                                <th>æ—¶é—´</th>
                                <th>é…ç½®</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for schedule in schedules %}
                            <tr>
                                <td>
                                    {% if schedule.type == 'content_crawl' %}
                                        <span class="badge bg-success">å†…å®¹é‡‡é›†</span>
                                    {% else %}
                                        <span class="badge bg-primary">é“¾æ¥æŠ“å–</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if schedule.schedule_type == 'daily' or schedule.type == 'daily' %}
                                        æ¯å¤©
                                    {% elif schedule.schedule_type == 'weekly' or schedule.type == 'weekly' %}
                                        æ¯å‘¨
                                        {% for day in schedule.days %}
                                            {% if day == 0 %}ä¸€{% endif %}
                                            {% if day == 1 %}äºŒ{% endif %}
                                            {% if day == 2 %}ä¸‰{% endif %}
                                            {% if day == 3 %}å››{% endif %}
                                            {% if day == 4 %}äº”{% endif %}
                                            {% if day == 5 %}å…­{% endif %}
                                            {% if day == 6 %}æ—¥{% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                <td>{{ schedule.time }}</td>
                                <td>
                                    {% if schedule.type == 'content_crawl' %}
                                        æ¥æº: {{ schedule.source_type or 'å…¨éƒ¨' }}<br>
                                        æ•°é‡: {{ schedule.limit }}
                                    {% else %}
                                        å…¬ä¼—å·: {{ schedule.account or 'å…¨éƒ¨' }}<br>
                                        æ•°é‡: {{ schedule.limit }}
                                    {% endif %}
                                </td>
                                <td>{{ schedule.created_at }}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger delete-schedule" data-id="{{ schedule.id }}">åˆ é™¤</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">æš‚æ— å®šæœŸä»»åŠ¡</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘ä»»åŠ¡æ‰§è¡Œè®°å½• -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>æœ€è¿‘ä»»åŠ¡æ‰§è¡Œè®°å½•</span>
                <a href="{{ url_for('view_logs') }}" class="btn btn-sm btn-outline-secondary">æŸ¥çœ‹å…¨éƒ¨</a>
            </div>
            <div class="card-body">
                <div class="logs-list">
                    {% if job_logs %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>å¼€å§‹æ—¶é—´</th>
                                <th>ç»“æŸæ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>ç»“æœ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in job_logs %}
                            <tr>
                                <td>{{ log.start_time }}</td>
                                <td>{{ log.end_time }}</td>
                                <td>
                                    {% if log.success %}
                                    <span class="badge bg-success">æˆåŠŸ</span>
                                    {% else %}
                                    <span class="badge bg-danger">å¤±è´¥</span>
                                    {% endif %}
                                </td>
                                <td>{{ log.message }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">æš‚æ— ä»»åŠ¡æ‰§è¡Œè®°å½•</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // åˆ‡æ¢æ¯å‘¨é€‰æ‹©å™¨æ˜¾ç¤º - é“¾æ¥æŠ“å–
            $('input[name="schedule_type"]').change(function() {
                if ($(this).val() === 'weekly') {
                    $('#daysSelector').show();
                } else {
                    $('#daysSelector').hide();
                }
            });

            // åˆ‡æ¢æ¯å‘¨é€‰æ‹©å™¨æ˜¾ç¤º - å†…å®¹é‡‡é›†
            $('#scheduleContentForm input[name="schedule_type"]').change(function() {
                if ($(this).val() === 'weekly') {
                    $('#contentDaysSelector').show();
                } else {
                    $('#contentDaysSelector').hide();
                }
            });

            // ç«‹å³æŠ“å–
            $('#crawlForm').submit(function(e) {
                e.preventDefault();
                const $btn = $('#crawlBtn');
                const $loading = $('#crawlLoading');
                const $alert = $('#crawlAlert');
                
                $btn.prop('disabled', true);
                $loading.show();
                $alert.hide();

                $.ajax({
                    url: '/crawl',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        $alert.removeClass('alert-success alert-danger')
                              .addClass(response.success ? 'alert-success' : 'alert-danger')
                              .html(response.message)
                              .show();
                    },
                    error: function() {
                        $alert.removeClass('alert-success')
                              .addClass('alert-danger')
                              .text('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
                              .show();
                    },
                    complete: function() {
                        $btn.prop('disabled', false);
                        $loading.hide();
                    }
                });
            });

            // æ›´æ–°å‡­è¯
            $('#updateCredBtn').click(function() {
                const $btn = $(this);
                const $loading = $('#updateCredLoading');
                const $alert = $('#updateCredAlert');

                $btn.prop('disabled', true);
                $loading.show();
                $alert.hide();

                $.ajax({
                    url: '/update_credentials',
                    type: 'POST',
                    success: function(response) {
                        $alert.removeClass('alert-success alert-danger')
                              .addClass(response.success ? 'alert-success' : 'alert-danger')
                              .text(response.message)
                              .show();
                    },
                    error: function() {
                        $alert.removeClass('alert-success')
                              .addClass('alert-danger')
                              .text('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
                              .show();
                    },
                    complete: function() {
                        $btn.prop('disabled', false);
                        $loading.hide();
                    }
                });
            });

            // æ‰‹åŠ¨URLé‡‡é›†
            $('#urlCrawlForm').submit(function(e) {
                e.preventDefault();
                const $btn = $('#urlCrawlBtn');
                const $loading = $('#urlCrawlLoading');
                const $alert = $('#urlCrawlAlert');

                const urls = $('#urlInput').val().trim();
                if (!urls) {
                    $alert.removeClass('alert-success')
                          .addClass('alert-danger')
                          .text('è¯·è¾“å…¥è¦é‡‡é›†çš„URL')
                          .show();
                    return;
                }

                $btn.prop('disabled', true);
                $loading.show();
                $alert.hide();

                $.ajax({
                    url: '/crawl_urls',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        let message = response.message;
                        if (response.success && response.results) {
                            const results = response.results;
                            const successful = results.filter(r => r.status === 'success').length;
                            const failed = results.filter(r => r.status === 'failed' || r.status === 'error').length;
                            const skipped = results.filter(r => r.status === 'skipped').length;
                            message += `<br><small>æ€»è®¡: ${results.length}ä¸ª, æˆåŠŸ: ${successful}ä¸ª, å¤±è´¥: ${failed}ä¸ª, è·³è¿‡: ${skipped}ä¸ª</small>`;
                        }
                        $alert.removeClass('alert-success alert-danger')
                              .addClass(response.success ? 'alert-success' : 'alert-danger')
                              .html(message)
                              .show();

                        if (response.success) {
                            // æ¸…ç©ºè¾“å…¥æ¡†
                            $('#urlInput').val('');
                            // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°çš„ç»Ÿè®¡
                            setTimeout(() => location.reload(), 3000);
                        }
                    },
                    error: function() {
                        $alert.removeClass('alert-success')
                              .addClass('alert-danger')
                              .text('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
                              .show();
                    },
                    complete: function() {
                        $btn.prop('disabled', false);
                        $loading.hide();
                    }
                });
            });

            // å†…å®¹é‡‡é›†
            $('#contentCrawlForm').submit(function(e) {
                e.preventDefault();
                const $btn = $('#contentCrawlBtn');
                const $loading = $('#contentCrawlLoading');
                const $alert = $('#contentCrawlAlert');

                $btn.prop('disabled', true);
                $loading.show();
                $alert.hide();

                $.ajax({
                    url: '/crawl_content',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        let message = response.message;
                        if (response.success && response.stats) {
                            message += `<br><small>å¤„ç†: ${response.stats.total_processed || 0}, æˆåŠŸ: ${response.stats.successful || 0}, å¤±è´¥: ${response.stats.failed || 0}</small>`;
                        }
                        $alert.removeClass('alert-success alert-danger')
                              .addClass(response.success ? 'alert-success' : 'alert-danger')
                              .html(message)
                              .show();

                        if (response.success) {
                            // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ›´æ–°çš„ç»Ÿè®¡
                            setTimeout(() => location.reload(), 3000);
                        }
                    },
                    error: function() {
                        $alert.removeClass('alert-success')
                              .addClass('alert-danger')
                              .text('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
                              .show();
                    },
                    complete: function() {
                        $btn.prop('disabled', false);
                        $loading.hide();
                    }
                });
            });

            // è®¾ç½®å®šæœŸæŠ“å–
            $('#scheduleForm').submit(function(e) {
                e.preventDefault();
                const $btn = $('#scheduleBtn');
                const $loading = $('#scheduleLoading');
                const $alert = $('#scheduleAlert');

                $btn.prop('disabled', true);
                $loading.show();
                $alert.hide();

                $.ajax({
                    url: '/schedule',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        $alert.removeClass('alert-success alert-danger')
                              .addClass(response.success ? 'alert-success' : 'alert-danger')
                              .text(response.message)
                              .show();

                        if (response.success) {
                            // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°å¢çš„ä»»åŠ¡
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        }
                    },
                    error: function() {
                        $alert.removeClass('alert-success')
                              .addClass('alert-danger')
                              .text('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
                              .show();
                    },
                    complete: function() {
                        $btn.prop('disabled', false);
                        $loading.hide();
                    }
                });
            });

            // è®¾ç½®å®šæœŸå†…å®¹é‡‡é›†
            $('#scheduleContentForm').submit(function(e) {
                e.preventDefault();
                const $btn = $('#scheduleContentBtn');
                const $loading = $('#scheduleContentLoading');
                const $alert = $('#scheduleContentAlert');

                $btn.prop('disabled', true);
                $loading.show();
                $alert.hide();

                $.ajax({
                    url: '/schedule_content',
                    type: 'POST',
                    data: $(this).serialize(),
                    success: function(response) {
                        $alert.removeClass('alert-success alert-danger')
                              .addClass(response.success ? 'alert-success' : 'alert-danger')
                              .text(response.message)
                              .show();

                        if (response.success) {
                            // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°å¢çš„ä»»åŠ¡
                            setTimeout(function() {
                                location.reload();
                            }, 1500);
                        }
                    },
                    error: function() {
                        $alert.removeClass('alert-success')
                              .addClass('alert-danger')
                              .text('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
                              .show();
                    },
                    complete: function() {
                        $btn.prop('disabled', false);
                        $loading.hide();
                    }
                });
            });

            // åˆ é™¤å®šæœŸæŠ“å–ä»»åŠ¡
            $('.delete-schedule').click(function() {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®šæœŸæŠ“å–ä»»åŠ¡å—ï¼Ÿ')) {
                    return;
                }
                
                const $btn = $(this);
                $btn.prop('disabled', true).text('åˆ é™¤ä¸­...');
                
                $.ajax({
                    url: '/delete_schedule',
                    type: 'POST',
                    data: { job_id: $btn.data('id') },
                    success: function(response) {
                        if (response.success) {
                            // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°ä»»åŠ¡åˆ—è¡¨
                            location.reload();
                        } else {
                            alert(response.message);
                            $btn.prop('disabled', false).text('åˆ é™¤');
                        }
                    },
                    error: function() {
                        alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        $btn.prop('disabled', false).text('åˆ é™¤');
                    }
                });
            });
        });
    </script>
</body>
</html> 