name: WZ Content Automation

on:
  # å®šæ—¶è§¦å‘ - æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 */6 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      link_limit:
        description: 'é“¾æ¥é‡‡é›†é™åˆ¶'
        required: false
        default: '3'
        type: string
      content_limit:
        description: 'å†…å®¹é‡‡é›†é™åˆ¶'
        required: false
        default: '50'
        type: string
      publish_limit:
        description: 'è®ºå›å‘å¸ƒé™åˆ¶'
        required: false
        default: '50'
        type: string
      steps:
        description: 'æ‰§è¡Œæ­¥éª¤ (link_crawl,content_crawl,forum_publish)'
        required: false
        default: 'link_crawl,content_crawl,forum_publish'
        type: string

env:
  PYTHONPATH: ${{ github.workspace }}
  PYTHONIOENCODING: utf-8

jobs:
  wz-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          gnupg \
          unzip \
          curl \
          xvfb \
          fonts-liberation \
          libasound2t64 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libgbm1 \
          libxss1 \
          libnss3
          
    - name: å®‰è£…Chromeæµè§ˆå™¨
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: å®‰è£…ChromeDriver
      run: |
        CHROME_VERSION=$(google-chrome --version | cut -d " " -f3 | cut -d "." -f1)
        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
        wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
        sudo unzip /tmp/chromedriver.zip -d /usr/local/bin/
        sudo chmod +x /usr/local/bin/chromedriver
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        echo "ğŸ“¦ å®‰è£…Pythonä¾èµ–åŒ…..."

        if [ -f requirements.txt ]; then
          echo "ä½¿ç”¨requirements.txtå®‰è£…ä¾èµ–"
          pip install -r requirements.txt
        else
          echo "ä½¿ç”¨é»˜è®¤ä¾èµ–åˆ—è¡¨å®‰è£…"
          # å®‰è£…æ ¸å¿ƒä¾èµ–
          pip install \
            mysql-connector-python \
            requests \
            beautifulsoup4 \
            lxml \
            selenium \
            DrissionPage \
            trafilatura \
            newspaper3k \
            jieba \
            python-dateutil \
            Pillow
        fi

        echo "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
        pip list | grep -E "(mysql|selenium|DrissionPage|trafilatura)"
        
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_NAME: ${{ secrets.DB_NAME }}
        FORUM_DB_HOST: ${{ secrets.FORUM_DB_HOST }}
        FORUM_DB_PORT: ${{ secrets.FORUM_DB_PORT }}
        FORUM_DB_USER: ${{ secrets.FORUM_DB_USER }}
        FORUM_DB_PASSWORD: ${{ secrets.FORUM_DB_PASSWORD }}
        FORUM_DB_NAME: ${{ secrets.FORUM_DB_NAME }}
      run: |
        mkdir -p wz/config
        cat > wz/config/config.json << EOF
        {
          "database": {
            "host": "${DB_HOST}",
            "port": ${DB_PORT},
            "user": "${DB_USER}",
            "password": "${DB_PASSWORD}",
            "database": "${DB_NAME}",
            "charset": "utf8mb4"
          },
          "cfcj": {
            "use_database": true,
            "headless": true,
            "user_agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          },
          "forum": {
            "discuz": {
              "host": "${FORUM_DB_HOST}",
              "port": ${FORUM_DB_PORT},
              "user": "${FORUM_DB_USER}",
              "password": "${FORUM_DB_PASSWORD}",
              "database": "${FORUM_DB_NAME}",
              "charset": "utf8mb4"
            }
          }
        }
        EOF
        
    - name: åˆ›å»ºGitHub Actionsä¸“ç”¨é…ç½®
      run: |
        LINK_LIMIT="${{ github.event.inputs.link_limit || '3' }}"
        CONTENT_LIMIT="${{ github.event.inputs.content_limit || '50' }}"
        PUBLISH_LIMIT="${{ github.event.inputs.publish_limit || '50' }}"

        cat > wz/github_actions_config.json << EOF
        {
          "steps": {
            "link_crawl": {
              "enabled": true,
              "params": {
                "limit_per_account": ${LINK_LIMIT},
                "total_limit": ${LINK_LIMIT},
                "accounts": ["all"]
              }
            },
            "content_crawl": {
              "enabled": true,
              "params": {
                "limit": ${CONTENT_LIMIT},
                "batch_size": 5,
                "source_types": ["wechat"]
              }
            },
            "forum_publish": {
              "enabled": true,
              "params": {
                "limit": ${PUBLISH_LIMIT},
                "interval_min": 30,
                "interval_max": 60
              }
            }
          }
        }
        EOF
        
    - name: è®¾ç½®æ˜¾ç¤ºç¯å¢ƒ
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        sleep 3
        
    - name: è¿è¡ŒWZè‡ªåŠ¨åŒ–å·¥ä½œæµ
      run: |
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        mkdir -p logs
        mkdir -p wz/logs

        cd wz
        export DISPLAY=:99

        # è§£ææ‰§è¡Œæ­¥éª¤
        STEPS="${{ github.event.inputs.steps || 'link_crawl,content_crawl,forum_publish' }}"

        # è¿è¡Œè‡ªåŠ¨åŒ–å·¥ä½œæµ
        echo "ğŸš€ å¼€å§‹æ‰§è¡ŒWZè‡ªåŠ¨åŒ–å·¥ä½œæµ"
        echo "æ‰§è¡Œæ­¥éª¤: $STEPS"

        if [ -f "github_actions_config.json" ]; then
          python auto_workflow.py --config github_actions_config.json --steps "$STEPS" 2>&1 | tee ../logs/workflow_execution.log
        else
          python auto_workflow.py --steps "$STEPS" 2>&1 | tee ../logs/workflow_execution.log
        fi

        # æ£€æŸ¥æ‰§è¡Œç»“æœ
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "âœ… å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : ${PIPESTATUS[0]}"
          exit 1
        fi
        
    - name: ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: wz-automation-logs-${{ github.run_number }}
        path: |
          logs/
          wz/logs/
        if-no-files-found: warn
        retention-days: 7
        
    - name: å‘é€é€šçŸ¥ (æˆåŠŸ)
      if: success()
      run: |
        echo "âœ… WZè‡ªåŠ¨åŒ–å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "æ‰§è¡Œæ­¥éª¤: ${{ github.event.inputs.steps || 'link_crawl,content_crawl,forum_publish' }}"
        
    - name: å‘é€é€šçŸ¥ (å¤±è´¥)
      if: failure()
      run: |
        echo "âŒ WZè‡ªåŠ¨åŒ–å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
